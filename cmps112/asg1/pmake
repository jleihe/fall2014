#!/usr/bin/perl
#Joshua Leihe - jleihe@ucsc.edu
#Some functions adapted from cmps 112 website
use strict;
use warnings;
use Getopt::Std;

sub getDeps ($) {
	my ($line) = @_;
	return undef unless $line =~ m/^(\S+)\s*:\s*(.*?)\s*$/;
	my ($target, $dependency) = ($1, $2);
	my @dependencies = split m/\s+/, $dependency;
	return $target, \@dependencies;
}

sub getMacros ($) {
	my ($line) = @_;
	return undef unless $line =~ m/(\w*)\s?=(.*)/;
	my ($macro, $content) = ($1, $2);
	return $macro, $content;
}

sub traverseDeps ($) {
	my ($head, %globalDeps) = @_;
	my @currentDeps = $globalDeps{$head};
}

my %options=();
getopts("dnf:",\%options);

my %deps;
my %macros;
my $filename = $options{f};
if (!(defined $filename)) {
	$filename = "Makefile";
}
open(my $file, '<', $filename)
  or die "Could not open file '$filename' $!";
  
my $firstTarget;
  
while (my $line = <$file>) {
		my ($target, $deps) = getDeps $line;
		
		#store first target if it exists on the current line
		if (!(defined $firstTarget) && defined $target) {
			$firstTarget = $target;
		}
		my ($macro, $content) = getMacros $line;
		
		$deps{$target} = $deps if defined $target;
		$macros{$macro} = $content if defined $macro; 
}


# main

# Make system calls

#check if option n was invoked
if (defined $options{n}) {
	#only prints out the system calls
	print "Entering preview mode";
} else {
	#actually make the system calls
	
}

#check if option d was invoked
if (defined $options{d}) {
	#print deps
	print "\n\nEntering debug mode!\n\n";
	
	print "First target: $firstTarget\n\n" if defined $firstTarget;
	print "Target file $ARGV[$#ARGV]\n\n" if defined $ARGV[$#ARGV];
	for my $target (keys %deps) {
		if (defined $target) {
			print "\"$target\"";
			my $dep = $deps{$target};
			if (not @$dep) {
				print " has no dependencies";
			}else {
				print " depends on";
				print " \"$_\"" for @$dep;
			}
			print "\n";
		}
	}

	#print macros
	#~ for my $macro (keys %macros) {
		#~ if (defined $macro) {
			#~ print "\"$macro\"";
			#~ my $content = $macros{$macro};
			#~ if (not @$content) {
				#~ print " has no dependencies";
			#~ }else {
				#~ print " depends on";
				#~ print " \"$_\"" for @$macro;
			#~ }
			#~ print "\n";
		#~ }
	#~ }
}
